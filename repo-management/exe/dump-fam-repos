#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler'
require 'bundler/setup'

require 'tty-table'
require 'dry-initializer'

require 'telefactor/repo_management'


def load_fresh_data
  Telefactor::RepoManagement::Fam.new.repos
end

def load_file_cache_data
  Marshal.load(File.read('./marshaled_data.txt'))
end

repos = load_fresh_data
# repos = load_file_cache_data

class TableCell
  class << self
    def from_repo(repo)
      new(repo: repo)
    end

    def header
      raise 'ABC method not implemented'
    end
  end

  def intialize(*)
    raise 'ABC cannot be constructed'
  end

  def value
    raise 'ABC method not implemented'
  end
end

class Name < TableCell
  def self.header
    'Name'
  end

  attr_reader :value

  def initialize(repo:)
    @value = repo.name
  end
end

class URL < TableCell
  def self.header
    'URL'
  end

  attr_reader :value

  def initialize(repo:)
    @value = repo.html_url
  end
end

NAME_SCHEMA_REGEXP = /(?<game>telefactor-fam)-(?<role>examiner|sourcerer)-(?<phase>\w*)/.freeze

class Phase < TableCell
  def self.header
    'Phase'
  end

  attr_reader :value

  def initialize(repo:)
    phase_word = (NAME_SCHEMA_REGEXP.match(repo.name)&.named_captures || {}).fetch('phase', '')
    @value = {
      '' => -1,
      'zero' => 0,
      'one' => 1,
      'two' => 2,
      'three' => 3,
      'four' => 4,
    }[phase_word.downcase]
  end
end

class Role < TableCell
  def self.header
    'Role'
  end

  attr_reader :value

  def initialize(repo:)
    @value = (NAME_SCHEMA_REGEXP.match(repo.name)&.named_captures || {}).fetch('role', 'GM')
  end
end

cell_classes = [
  Phase,
  Role,
  Name,
  URL,
]

rows = repos.map do |repo|
  cell_classes.map do |cell_class|
    cell_class.from_repo(repo).value
  end
end

rows.sort!

table = TTY::Table.new(
  header: cell_classes.map(&:header),
  rows: rows
)

class MarkdownBorder < TTY::Table::Border
  def_border do
    mid '-'
    mid_left '|'
    mid_mid '|'
    mid_right '|'

    left '|'
    center '|'
    right '|'
  end
end

rendered_table = table.render_with(MarkdownBorder)

puts rendered_table
